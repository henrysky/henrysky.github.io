<!DOCTYPE html>
<html lang="en">

<head>
    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="Personal Website of Henry W. Leung" />
    <meta name="author" content="Henry W. Leung" />
    <meta name="theme-color" content="#003366"/>
    <title>Converting Keras 1D Convulution to PyTorch | Henry Leung&#39;s Personal Website</title>
    <link rel="icon" type="image/x-icon" href=https://henrysky.github.io/assets/favicon.ico />
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.3/simple-lightbox.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css">
    <link href=https://henrysky.github.io/css/styles.css rel="stylesheet" />
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KBFQQ2QV4Q"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-KBFQQ2QV4Q');
    </script>
    <script>
        var theme = localStorage.getItem('theme') || 'auto';
        document.documentElement.setAttribute('data-bs-theme', theme);

        function setDarkTheme() {
            if (theme == 'auto') {
                theme = 'dark';
            }
            else if (theme == 'light') {
                theme = 'auto';
            } else {
                theme = 'light';
            }
            setButtonIcon();
            localStorage.setItem('theme', theme);
        };

        function setAutoCorrectTheme() {
            if (theme == 'auto') {
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.setAttribute('data-bs-theme', 'dark');
                } else {
                    document.documentElement.setAttribute('data-bs-theme', 'light');
                }
            } 
            else {
                document.documentElement.setAttribute('data-bs-theme', theme);
            }
        };

        function setButtonIcon() {
            setAutoCorrectTheme();
            if (theme == 'auto') {
                document.getElementById("themebutton").className = "fa-solid fa-circle-half-stroke d-lg-flex justify-content-center";
            }
            else if (theme == 'light') {
                document.getElementById("themebutton").className = "fa-solid fa-sun d-lg-flex justify-content-center";
            }
            else if (theme == 'dark') {
                document.getElementById("themebutton").className = "fa-solid fa-moon d-lg-flex justify-content-center";
            }
        };

    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
    MathJax = {
        tex: {
        displayMath: [['\\[', '\\]'], ['$$', '$$']],  
        inlineMath:  [['\\(', '\\)'], ['$', '$']],  
        }
    };
    </script>
</head>
    <style>
        .page-section img {
            max-width: 1000px;
            width: 100%
        }
    </style>
</head>

<body id="page-top">
    
    
<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top" id="mainNav">
    <div class="container-xl">
        <a href=https://henrysky.github.io/en>
            <img src=https://henrysky.github.io/assets/img/profile.jpg alt="My profile picture" title="Home Page"
                class="img-fluid rounded-circle"></a>
        <div class="col-md-4 d-inline-block me-auto">
            <div class="site-logo">
                <h3 style="margin-bottom: 0px; font-weight: bolder;">
                    Henry Leung
                </h3>
                <p style="margin-bottom: 0px; font-size:14px; color: darkgray;">
                    Astronomy &amp; Deep Learning
                </p>
            </div>
        </div>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive"
            aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"><span
                class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav ms-auto" id="pagemenu">
                
                <li class="nav-item">
                    <a href="/" class="nav-link" id="About">
                        <i class="fa-solid fa-user d-lg-flex" title="About Me"></i>
                        <span>About</span>
                    </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://henrysky.github.io/photography/" class="nav-link" id="Photos">
                        <i class="fa fa-camera d-lg-flex" title="My Astrophotography"></i>
                        <span>Photos</span>
                    </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://henrysky.github.io/codes/" class="nav-link" id="Codes">
                        <i class="fa fa-code d-lg-flex" title="Featured Code"></i>
                        <span>Codes</span>
                    </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://henrysky.github.io/research/" class="nav-link" id="Research">
                        <i class="fa fa-flask d-lg-flex" title="My Research"></i>
                        <span>Research</span>
                    </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://henrysky.github.io/publication/" class="nav-link" id="Papers">
                        <i class="fa fa-book d-lg-flex" title="My Publications"></i>
                        <span>Papers</span>
                    </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://henrysky.github.io/cv/" class="nav-link" id="CV">
                        <i class="fa-solid fa-timeline d-lg-flex" title="My Résumé"></i>
                        <span>CV</span>
                    </a>
                </li>
                
                
                <li class="nav-item">
                    <a href="/blog" class="nav-link" id="Blog">
                        <i class="fab fa fa-blogger d-lg-flex" title="My Blog"></i>
                        <span>Blog</span>
                    </a>
                </li>
            </ul>
            
            <ul class="navbar-nav">
                <li class="nav-item ">
                    <span id="langmenu">
                        
                            <a href=https://henrysky.github.io/zh class="nav-link" style="min-width: 30px; /* make it shorter */" id="Cantonese" 
                            title="Cantonese - 廣東話">粵</a>
                        
                    </span>
                </li>
            </ul>

            <ul class="navbar-nav" id="thememenu">
                <li class="nav-item ">
                    <a href="javascript:void(0);" onclick="setDarkTheme()" class="nav-link" style="min-width: 30px; /* make it shorter */">
                        <i class="fa-solid fa-circle-half-stroke d-lg-flex justify-content-center"
                            title="Toggle Light/Dark theme" id="themebutton"></i>
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>

    <section class="blog-section py-0 py-md-4" , id="header1">
        <div class="container-xl px-0 px-md-4 text-left">
            <div class="row">
                <div class="col-lg-12 col-xl-9" style="overflow-x: hidden;">
                    <div class="card">
                        <div class="card-header">
                            <h1>Converting Keras 1D Convulution to PyTorch</h1>
                            <small>
                                <span class="item" style="padding-right: 10px;">
                                    <i class="far fa-calendar-check"></i> 10 Oct 2023
                                </span>
                                <span class="item" style="padding-right: 10px;">
                                    <i class="fa fa-user"></i> Henry Leung
                                </span>
                                <span class="item">
                                    <i class="fa fa-tag"></i>
                                </span>
                                 


 <span class="badge rounded-pill text-bg-primary"><a href="https://henrysky.github.io/tags/deeplearning/" class="text-white text-decoration-none">deeplearning</a></span> <span class="badge rounded-pill text-bg-primary"><a href="https://henrysky.github.io/tags/keras/" class="text-white text-decoration-none">keras</a></span> <span class="badge rounded-pill text-bg-primary"><a href="https://henrysky.github.io/tags/pytorch/" class="text-white text-decoration-none">pytorch</a></span>
                            </small>
                        </div>
                        <div class="card-body p-2 p-md-4">
                            <div class="post-content">
                                
                                <p>Recently I need to convert a model including 1D convolution layers trained with Keras v2 to PyTorch.
Since Keras uses channels last $(N, L, C)$ and PyTorch uses channels first $(N, C, L)$, the weight matrix needs to be
transposed in a consistent way such that the output of the two models are the same after flattening.</p>
<p>We can do a simple test to make sure we know how to transpose the weight matrix. Here we will create a simple model
in Keras and PyTorch first and get the weight matrix from the Keras model and transpose it to PyTorch format,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">keras</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Conv1D</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Flatten</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">np_rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">set_random_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="n">np_rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ======================= Keras =======================</span>
</span></span><span class="line"><span class="cl"><span class="n">conv1d_keras</span> <span class="o">=</span> <span class="n">Conv1D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dense1_keras</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Forward pass of Keras model</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">dense1_keras</span><span class="p">(</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">conv1d_keras</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ======================= PyTorch =======================</span>
</span></span><span class="line"><span class="cl"><span class="n">x_torch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">x_torch</span> <span class="o">=</span> <span class="n">x_torch</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Pytorch expects channels first</span>
</span></span><span class="line"><span class="cl"><span class="n">conv1d_torch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dense1_torch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">254</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Keras to Pytorch weights conversion</span>
</span></span><span class="line"><span class="cl"><span class="n">conv1d_torch</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">conv1d_keras</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl"><span class="n">conv1d_torch</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">conv1d_keras</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl"><span class="n">dense1_torch</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">dense1_keras</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl"><span class="n">dense1_torch</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">dense1_keras</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Forward pass of PyTorch model</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">dense1_torch</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">conv1d_torch</span><span class="p">(</span><span class="n">x_torch</span><span class="p">))))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>which gives the output,</p>
<p><code>tensor([[0.7114]], grad_fn=&lt;AddBackward0&gt;)</code><br>
<code>tensor([0.5577], grad_fn=&lt;ViewBackward0&gt;)</code></p>
<p>The output of the two models are DIFFERENT. But why?
We have transposed the weight matrix, right? The reason is that the weight matrix of the Keras model
is not in the same order as the PyTorch model even thought they share the same shape which cause the
code to fail silently. To make sure the weight matrix is in the correct order after flattening,
we need to make the matrix is in the order of channel last $(N, L, C)$ again before flattening! So the correct code of forward pass for PyTorch model should be,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">dense1_torch</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">conv1d_torch</span><span class="p">(</span><span class="n">x_torch</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>which gives the output,</p>
<p><code>tensor([0.4469], grad_fn=&lt;ViewBackward0&gt;)</code></p>
<p>Now both models share the same weight matrixes and produce the same output.</p>

                            </div>
                            <hr>

                            <nav aria-label="Page navigation">
                                <div class="row">
                                    <div class="col-12 col-lg-5">
                                        
                                    </div>
                                    <div class="d-none d-md-block col-lg-2">
                                        <span aria-hidden="true">

                                        </span>
                                    </div>
                                    <div class="col-12 col-lg-5">
                                        
                                        <a href="https://henrysky.github.io/blog/2023-01-19-post/" class="float-end"> Previous: Blogging with Hugo<i
                                                class="fa-solid fa-right-long"></i></a>
                                        
                                    </div>
                                </div>
                            </nav>
                        </div>
                    </div>
                </div>
                <div class="d-none d-xl-block col-lg-1 col-xl-3 affix" style="overflow-x: hidden;">
                    <div class="card" style="margin-bottom: 20px">
                        <div class="card-header" style="display: flex; align-items: center; justify-content: center; text-align: center;">
                            <span><i class="fa-solid fa-magnifying-glass"></i>Search</span>
                        </div>
                        <div class="card-body p-2">
                            <input type="text" id="search_box" class="form-control" placeholder="Search...">

                        </div>
                    </div>
                    <div class="card" style="margin-bottom: 20px">
                        <div class="card-header" style="display: flex; align-items: center; justify-content: center; text-align: center;">
                            <span><i class="fa-solid fa-magnifying-glass"></i>Tags</span>
                        </div>
                        <div class="card-body p-2">
                            
                            
                            
                            <li><a href="https://henrysky.github.io/tags/deeplearning/">DeepLearning</a></li>
                            
                            <li><a href="https://henrysky.github.io/tags/keras/">Keras</a></li>
                            
                            <li><a href="https://henrysky.github.io/tags/pytorch/">PyTorch</a></li>
                            
                            <li><a href="https://henrysky.github.io/tags/windows/">Windows</a></li>
                            
                            <li><a href="https://henrysky.github.io/tags/general/">General</a></li>
                            
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    
<footer class="py-4 bg-dark">
    <div class="container px-4 px-lg-5">
        <div class="row">
            <div class="col-lg-3 d-none d-md-none d-lg-block">
            <div class="small text-center text-muted"></div>
            </div>
            <div class="col-lg-6 col-md-12" style="display:flex;flex-direction: column;justify-content: center;">
            <div class="m-0 text-center text-white">Copyrighted &copy; 2018-2025
                                Henry W. Leung. <br> Last Updated: December 4, 2024</div>
            </div>
            <div class="col-lg-3 d-none d-md-none d-lg-flex" style="flex-direction: column;justify-content: center;">
                <ul class="nav-item text-center" style="margin-bottom: 0px;">
                <span class="fa-stack fa-1x" style="flex-shrink: 0;">
                    <a href="https://github.com/henrysky" target="_blank">
                    <i class="fab fa-github fa-stack-2x fa-inverse" style="--fa-inverse:var(--fa-navy); "title="My Github profile"></i>
                </a>
                </span>
                <span class="fa-stack fa-1x" style="flex-shrink: 0;">
                    <a href="https://www.linkedin.com/in/henry-leung-2664b3259/" target="_blank">
                    <i class="fab fa-linkedin fa-stack-2x fa-inverse" style="--fa-inverse:var(--fa-navy);" title="My Linkedin profile"></i>
                </a>
                </span>
                <span class="fa-stack fa-1x" style="flex-shrink: 0;">
                    <a href=https://henrysky.github.io/blog/ target="_blank">
                    <i class="fab fa-blogger fa-stack-2x fa-inverse" style="--fa-inverse:var(--fa-navy);" title="My Blog"></i>
                </a>
                </span>
                </ul>
            </div>
        </div>
        </div>
</footer>

<script src=https://henrysky.github.io/js/bootstrap.min.js></script>
<script src=https://henrysky.github.io/js/copy_code.js></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.3/simple-lightbox.min.js"></script>

<script>
    function isMobileDevice() {
        return /Mobi|Android|iPhone|iPad|iPod|BlackBerry|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
    }

    window.onload = function() {
        if (isMobileDevice()) {
            
            pdfContainer = document.getElementById('pdf-container');
            
            if (pdfContainer) {
                pdfContainer.style.display = 'none';
                document.getElementById('mobile-warning').style.display = 'block';
            }
        }
    };
</script>
<script>
    
    (function() {
        var $gallery1 = new SimpleLightbox('#about-gallery a', {});
        var $gallery2 = new SimpleLightbox('#astrophotography a', {});
        var $gallery3 = new SimpleLightbox('#research a', {});
        var $gallery4 = new SimpleLightbox('#edu a', {});
    })();

    
    setButtonIcon();

    
    
    
    
    if ("blog" == 'blog') {  
        document.getElementById("Blog").className += " active";
    } 
    else {
        try {
            document.getElementById("Converting Keras 1D Convulution to PyTorch").className += " active";
        }
        catch(err) {
            console.log("No active element found");
        }
    }
</script>

<script>
    document.getElementById("page-top").onscroll = function myFunction() {  
        var scrolltotop = document.scrollingElement.scrollTop;
        var target = document.getElementById("header1");
        var xvalue = "center";
        var factor = 0.5;
        var yvalue = scrolltotop * factor;
        target.style.backgroundPosition = xvalue + " " + yvalue + "px";
    }
</script>

</body>

</html>